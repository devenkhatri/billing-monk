# Google Sheets Setup

Google Sheets serves as the backend database for Billing Monk. This guide walks you through setting up the Google Sheets integration, from creating the necessary sheets to configuring proper permissions.

## Overview

The Google Sheets integration provides:
- **Data Storage**: All business data stored in your Google Sheets
- **Real-time Sync**: Changes sync immediately between app and sheets
- **Data Ownership**: You maintain full control of your data
- **Backup & Recovery**: Built-in Google Drive backup and version history
- **Accessibility**: Direct access to data through Google Sheets interface

## Prerequisites

Before setting up Google Sheets integration:
- Google account with Sheets access
- Google Cloud Console project with APIs enabled
- Service account with proper credentials
- Basic understanding of Google Sheets

## Automatic Setup (Recommended)

### Using the Setup Wizard

The application includes an automatic setup wizard that creates the necessary Google Sheets structure:

#### Step 1: Initial Authentication
1. Complete the OAuth authentication process
2. Grant necessary permissions for Google Sheets access
3. The system will check for existing spreadsheet configuration

#### Step 2: Spreadsheet Creation
1. If no spreadsheet is configured, the setup wizard will appear
2. Click "Create New Spreadsheet" to automatically generate the structure
3. The system will create a new Google Spreadsheet with all required sheets
4. Proper permissions will be set automatically

#### Step 3: Verification
1. The system will test the connection to ensure everything works
2. Sample data may be created to verify functionality
3. You'll receive confirmation that setup is complete

### What Gets Created Automatically

The automatic setup creates:
- **New Google Spreadsheet**: Named "Billing Monk Data"
- **Required Sheets**: All necessary sheets with proper column headers
- **Permissions**: Service account granted editor access
- **Initial Configuration**: Basic settings and structure

## Manual Setup

If you prefer manual setup or need to troubleshoot automatic setup:

### Step 1: Create Google Spreadsheet

#### Create New Spreadsheet
1. Go to [Google Sheets](https://sheets.google.com)
2. Click "Blank" to create a new spreadsheet
3. Rename it to "Billing Monk Data" (or your preferred name)
4. Note the Spreadsheet ID from the URL

#### Get Spreadsheet ID
The Spreadsheet ID is found in the URL:
```
https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit#gid=0
```
Copy the `SPREADSHEET_ID` portion for your environment variables.

### Step 2: Create Required Sheets

Create the following sheets with exact names:

#### Clients Sheet
**Sheet Name**: `Clients`
**Column Headers** (Row 1):
```
ID | Name | Email | Phone | Street | City | State | ZipCode | Country | CreatedAt | UpdatedAt
```

#### Invoices Sheet
**Sheet Name**: `Invoices`
**Column Headers** (Row 1):
```
ID | InvoiceNumber | ClientID | Status | IssueDate | DueDate | Subtotal | TaxRate | TaxAmount | Total | PaidAmount | Balance | Notes | CreatedAt | UpdatedAt
```

#### LineItems Sheet
**Sheet Name**: `LineItems`
**Column Headers** (Row 1):
```
ID | InvoiceID | Description | Quantity | Rate | Amount
```

#### Payments Sheet
**Sheet Name**: `Payments`
**Column Headers** (Row 1):
```
ID | InvoiceID | Amount | PaymentDate | PaymentMethod | Notes | CreatedAt
```

#### Settings Sheet
**Sheet Name**: `Settings`
**Column Headers** (Row 1):
```
Key | Value | UpdatedAt
```

#### Templates Sheet
**Sheet Name**: `Templates`
**Column Headers** (Row 1):
```
ID | Name | Description | LineItems | CreatedAt | UpdatedAt
```

### Step 3: Configure Permissions

#### Share with Service Account
1. Click "Share" button in the top-right of your spreadsheet
2. Add your service account email (from the JSON key file)
3. Set permission level to "Editor"
4. Uncheck "Notify people" to avoid sending notification emails
5. Click "Share"

#### Verify Permissions
Ensure the service account has:
- **Editor access**: Can read and write data
- **Proper email**: Matches the service account email exactly
- **No expiration**: Access doesn't expire

### Step 4: Configure Environment Variables

Add the spreadsheet ID to your environment variables:
```bash
GOOGLE_SPREADSHEET_ID=your-spreadsheet-id-here
```

## Sheet Structure Details

### Data Types and Formats

#### ID Fields
- **Format**: Unique string identifiers
- **Generation**: Automatically generated by the application
- **Example**: `client_abc123`, `invoice_def456`

#### Date Fields
- **Format**: ISO 8601 date strings
- **Example**: `2024-01-15T10:30:00Z`
- **Timezone**: UTC for consistency

#### Monetary Fields
- **Format**: Decimal numbers
- **Precision**: Two decimal places
- **Example**: `1234.56`

#### Status Fields
- **Invoice Status**: `draft`, `sent`, `paid`, `overdue`, `cancelled`
- **Payment Status**: `pending`, `completed`, `failed`

### Relationships Between Sheets

#### Client to Invoice Relationship
- **Clients.ID** → **Invoices.ClientID**
- One client can have multiple invoices
- Client deletion should be handled carefully

#### Invoice to LineItems Relationship
- **Invoices.ID** → **LineItems.InvoiceID**
- One invoice can have multiple line items
- Line items are deleted when invoice is deleted

#### Invoice to Payments Relationship
- **Invoices.ID** → **Payments.InvoiceID**
- One invoice can have multiple payments
- Payments track partial and full payments

### Data Validation Rules

#### Required Fields
- **Clients**: ID, Name, Email
- **Invoices**: ID, InvoiceNumber, ClientID, Status, IssueDate, DueDate, Total
- **LineItems**: ID, InvoiceID, Description, Quantity, Rate, Amount
- **Payments**: ID, InvoiceID, Amount, PaymentDate

#### Format Validation
- **Email**: Valid email format required
- **Dates**: ISO 8601 format required
- **Numbers**: Decimal format for monetary values
- **IDs**: Unique across their respective sheets

## Advanced Configuration

### Custom Sheet Names

If you need to use different sheet names:

1. **Update Environment Variables**:
```bash
GOOGLE_SHEETS_CLIENTS_SHEET=CustomClientsName
GOOGLE_SHEETS_INVOICES_SHEET=CustomInvoicesName
GOOGLE_SHEETS_LINEITEMS_SHEET=CustomLineItemsName
GOOGLE_SHEETS_PAYMENTS_SHEET=CustomPaymentsName
GOOGLE_SHEETS_SETTINGS_SHEET=CustomSettingsName
```

2. **Ensure Consistency**: All references must use the custom names

### Multiple Spreadsheets

For advanced setups with multiple spreadsheets:

1. **Separate by Function**:
   - One spreadsheet for clients and invoices
   - Another for payments and reports
   - Third for settings and templates

2. **Environment Configuration**:
```bash
GOOGLE_SPREADSHEET_ID_MAIN=main-spreadsheet-id
GOOGLE_SPREADSHEET_ID_PAYMENTS=payments-spreadsheet-id
GOOGLE_SPREADSHEET_ID_SETTINGS=settings-spreadsheet-id
```

### Data Archiving

For large datasets, consider archiving:

1. **Archive Old Data**: Move old invoices to archive sheets
2. **Maintain Performance**: Keep active data in main sheets
3. **Backup Strategy**: Regular exports of archived data

## Troubleshooting

### Common Issues

#### Permission Denied Errors
**Symptoms**: "The caller does not have permission" errors
**Solutions**:
1. Verify service account email is correct
2. Ensure spreadsheet is shared with service account
3. Check that service account has "Editor" permissions
4. Confirm Google Sheets API is enabled

#### Sheet Not Found Errors
**Symptoms**: "Unable to parse range" or "Sheet not found" errors
**Solutions**:
1. Verify sheet names match exactly (case-sensitive)
2. Ensure all required sheets exist
3. Check for extra spaces in sheet names
4. Confirm spreadsheet ID is correct

#### Data Not Syncing
**Symptoms**: Changes in app don't appear in sheets or vice versa
**Solutions**:
1. Check internet connectivity
2. Verify API quotas haven't been exceeded
3. Ensure service account credentials are valid
4. Check for Google Sheets service outages

#### Column Header Mismatches
**Symptoms**: Data appears in wrong columns or not at all
**Solutions**:
1. Verify column headers match exactly
2. Check for extra spaces or special characters
3. Ensure headers are in row 1
4. Confirm column order matches specification

### Performance Optimization

#### Reduce API Calls
- **Batch Operations**: Group multiple updates together
- **Caching**: Cache frequently accessed data
- **Selective Updates**: Only update changed fields
- **Pagination**: Use pagination for large datasets

#### Sheet Organization
- **Separate Sheets**: Don't put all data in one sheet
- **Index Columns**: Use ID columns for efficient lookups
- **Data Types**: Use appropriate data types for each column
- **Cleanup**: Regularly remove unnecessary data

### Monitoring and Maintenance

#### Regular Checks
- **Data Integrity**: Verify relationships between sheets
- **Performance**: Monitor API usage and response times
- **Backups**: Ensure regular backups are created
- **Access**: Review and update permissions as needed

#### API Usage Monitoring
- **Quotas**: Monitor Google Sheets API quotas
- **Rate Limits**: Implement proper rate limiting
- **Error Handling**: Log and handle API errors gracefully
- **Usage Patterns**: Analyze usage to optimize performance

## Security Considerations

### Access Control
- **Service Account**: Use dedicated service account, not personal account
- **Minimal Permissions**: Grant only necessary permissions
- **Regular Rotation**: Rotate service account keys regularly
- **Audit Access**: Regularly review who has access to spreadsheets

### Data Protection
- **Encryption**: Data encrypted in transit and at rest by Google
- **Backup**: Maintain regular backups of critical data
- **Recovery**: Test data recovery procedures
- **Compliance**: Ensure compliance with data protection regulations

## Next Steps

After setting up Google Sheets:

1. **[Configure Authentication](./authentication-setup.md)** - Set up user authentication
2. **[Test the Integration](./installation.md#verification)** - Verify everything works
3. **[Deploy the Application](./deployment/vercel.md)** - Deploy to production
4. **[Set up Monitoring](./maintenance/monitoring.md)** - Monitor system health

## Related Topics

- [Installation Guide](./installation.md)
- [Environment Variables](./environment-variables.md)
- [Authentication Setup](./authentication-setup.md)
- [Troubleshooting](./maintenance/troubleshooting.md)
- [API Documentation](../api/overview.md)